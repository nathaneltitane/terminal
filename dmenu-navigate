#!/bin/bash

lines=60

path_selection="${HOME}"
prompt="${path_selection}"

history_entry_count=3
history_file="${HOME}"/.local/bin/.dmenu-navigate-history

file_manager="ranger"
terminal="i3-sensible-terminal"

list="ls -a"
read="cat"

selections_empty_label=''
selections_separator_label='////////////////////////////////////////////////////////////////////////////////'

selections_history_label='[ History ]  â†´'
selections_terminal_label='[ Open Terminal Here ]'
selections_terminal_visual_label='[ Open Visual Terminal Here ]'

handler_open () {

	xdg-open "${@}"
}

terminal_open () {

	"${terminal}" --working-directory="${@}"
}

terminal_open_visual () {

	"${terminal}" --command="${file_manager} ${@}"
}

history_write () {

	sed -i "\:${1}:d" "${history_file}"

	printf '%s\n' "$1" >> "${history_file}"

	printf '%s\n' "$(tail -n "${history_entry_count}" "${history_file}")" > "${history_file}"
}

selections_parse () {

	selections=(
		"${selections_terminal_label}"
		"${selections_terminal_visual_label}"
		"${selections_separator_label}"
		"$(${list} "${path_selection}")"
		"${selections_empty_label}"
		"${selections_history_label}"
		"${selections_empty_label}"
		"$(${read} "${history_file}")"
	)

	IFS=$"\n"

	for selection in "${selections[@]}"
	do
		echo "${selection}"
	done

	IFS=""
}

while :
do
	navigation="$(selections_parse | dmenu -i -l "${lines}" -p "${prompt}" -nb '#000000' -nf '#FFFFFF' -sb '#666666' -sf '#000000' "${@}")" || exit 1

	if [ "${navigation}" == '[ Open Terminal Here ]' ]
	then
		terminal_open "${path_selection}"

		history_write "${path_selection}"

	elif [ "${navigation}" == '[ Open Visual Terminal Here ]' ]
	then
		terminal_open_visual "${path_selection}"

		history_write "${path_selection}"

	elif [[ "${navigation}" == '/'* ]]
	then
		path_selection="${navigation}"

	elif [[ "${navigation}" =~ ^(https?|ftps): ]]
	then
		handler_open "${navigation}"

		history_write "${navigation}"

	else
		path_selection="$(realpath "${path_selection}/${navigation}")"
	fi

	if [ -f "${path_selection}" ] || [ "${navigation}" = '.' ]
	then
		handler_open "${path_selection}"

		history_write "${path_selection}"

	elif [ -d "${path_selection}" ]
	then
		selections=(
			"${selections_terminal_label}"
			"${selections_terminal_visual_label}"
			"$(${list} "${path_selection}")"
		)
	else
		path_selection="$(dirname "${path_selection}")"
	fi
done
