#!/bin/bash

lines=60

path_selection="${HOME}"
prompt="${path_selection}"

history_entry_count=3
history_file="${HOME}"/.local/bin/.dmenu-navigate-history

file_manager="ranger"
list="ls -a"
terminal="i3-sensible-terminal"

command_open () {

	xdg-open "${@}"
}

command_open_terminal () {

	"${terminal}" --working-directory="${@}"
}

command_open_terminal_visual () {

	"${terminal}" --command="${file_manager} ${@}"
}

history_write () {

    sed -i "\:${1}:d" "${history_file}"

    printf '%s\n' "$1" >> "${history_file}"

    printf '%s\n' "$(tail -n "${history_entry_count}" "${history_file}")" > "${history_file}"
}

selections=(
	'[ Open Terminal Here ]'
	'[ Open Visual Terminal Here ]'
	"$(${list} "${path_selection}")"
	"$(cat "${history_file}")"
)

while :
do
	navigation="$(printf '%s\n' "${selections[@]}" | dmenu -i -l "${lines}" -p "${prompt}" -nb '#000000' -nf '#FFFFFF' -sb '#666666' -sf '#000000' "${@}")" || exit 1

	if [ "${navigation}" == '[ Open Terminal Here ]' ]
	then
		command_open_terminal "${path_selection}"

		history_write "${path_selection}"

	elif [ "${navigation}" == '[ Open Visual Terminal Here ]' ]
	then
		command_open_terminal_visual "${path_selection}"

		history_write "${path_selection}"

	elif [[ "${navigation}" == '/'* ]]
	then
		path_selection="${navigation}"

	elif [[ "${navigation}" =~ ^(https?|ftps): ]]
	then
		command_open "${navigation}"

		history_write "${navigation}"

	else
		path_selection="$(realpath "${path_selection}/${navigation}")"
	fi

	if [ -f "${path_selection}" ] || [ "${navigation}" = '.' ]
	then
		command_open "${path_selection}"

		history_write "${path_selection}"

	elif [ -d "${path_selection}" ]
	then
		selections=(
			'[ Open Terminal Here ]'
			'[ Open Visual Terminal Here ]'
			"$(${list} "${path_selection}")"
		)
	else
		path_selection="$(dirname "${path_selection}")"
	fi
done
