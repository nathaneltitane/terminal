#!/bin/bash

# bash /////////////////////////////////////////////////////////////////////////

if [ -n "${BASH_VERSION}" ]
then
	if [ -f "${HOME}"/.bashrc ]
	then
		. "${HOME}"/.bashrc
	fi
fi

# path /////////////////////////////////////////////////////////////////////////

if [ -d "${HOME}"/bin ]
then
	PATH="${HOME}/bin:${PATH}"
fi

if [ -d "${HOME}"/.local/bin ]
then
	PATH="${HOME}/.local/bin:${PATH}"
fi

# dependencies /////////////////////////////////////////////////////////////////

if [[ -z $(command -v frobulator) ]]
then
	curl -s -L get.frbltr.app > "${PREFIX}"/bin/frobulator
fi

. "${PREFIX}"/bin/frobulator

# dextop ///////////////////////////////////////////////////////////////////////

if [ -f "${HOME}"/.dextop/dextop ]
then
	if [[ $(cat "${HOME}"/.dextop/dextop-option) = xfce ]]
	then
		session_name="XFCE"
	else
		session_name="CONSOLE"
	fi

	[ -f /etc/os-release ] && . /etc/os-release && name="${NAME}"

	# settings

	if [ ! -f "${HOME}"/.dextop/dextop-settings-checkpoint ]
	then
		frobulator.fwd "Setting up..."
		echo

		dbus-launch "${PREFIX}"/bin/container-settings

		frobulator.file "${HOME}"/.dextop dextop-settings-checkpoint

		frobulator.clear
	fi

	# update #

	if [[ $(ps -A | grep -i proot) ]]
	then
		:
	else
		if [[ $(cat "${HOME}"/.dextop/dextop-update) = "update" ]]
		then
			frobulator.fwd "Updating..."
			echo

			utilities_list+=(
				termux-directories
				termux-packages
				termux-repositories
				termux-storage
				termux-update
				container-expansion
				container-image
				container-packages
				container-repositories
				container-session
				container-settings
				container-system
				container-user
			)

			frobulator.download get.dxtp.app "${PREFIX}"/bin ${utilities_list[@]}

			frobulator.clear
		fi
	fi

	# welcome #

	if [[ $(ps -A | grep -i proot) ]]
	then
		frobulator.fwd "Welcome to Dextop" "[ ${name} ]"
		echo

		if [ -f "${HOME}"/.vnc/selection ]
		then
			frobulator.inf "You have already logged in - vnc selection has been saved."
			frobulator.inf "Automatic session launch on shell login is enabled."
			echo
		else
			frobulator.wrn "This is your first login:"
			frobulator.wrn "Run 'container-session -o' to launch session [ ${session_name} ]."
			echo
		fi
	else
		frobulator.fwd "Welcome to Dextop" "[ Termux ]"
		echo

		frobulator.inf "Launch session: 'container-session -u <username> | -a <application>'"
	fi

	echo
fi
