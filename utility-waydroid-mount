#!/bin/bash

# dependencies /////////////////////////////////////////////////////////////////

if [ -f "${HOME}"/.local/bin/frobulator ]
then
	rm -r -f "${HOME}"/.local/bin/frobulator
fi

if [[ -z $(command -v frobulator) ]]
then
	if [[ $(id -u -n) = "root" ]]
	then
		SUDO_HOME=/root

		USER="${SUDO_USER}"

		HOME=/home/"${USER}"
	fi

	if [[ -z $(command -v curl) ]]
	then
		yes | apt-get install curl
	fi

	if [ ! -d "${HOME}"/.local/bin ]
	then
		mkdir -p "${HOME}"/.local/bin
	fi

	curl -s -L get.frbltr.app > "${HOME}"/.local/bin/frobulator

	chmod +x "${HOME}"/.local/bin/frobulator
fi

. "${HOME}"/.local/bin/frobulator

# superuser ////////////////////////////////////////////////////////////////////

export self_arguments="${@}"

# frobulator.escalate

# defaults /////////////////////////////////////////////////////////////////////

list=(
	dbus-x11
	weston
)

frobulator.require ${list[@]}

list=()

# variables ////////////////////////////////////////////////////////////////////

compositor=$(command -v weston)

android_media="${HOME}"/.local/share/waydroid/data/media/0

host_media=/media

android_directories_list=(
	Drive
	Music
)

host_directories_list=(
	internal
	"/${USER}/Samsung T7/music"
)

# functions ////////////////////////////////////////////////////////////////////

compositor_configure () {

	cat <<- FILE > "${HOME}"/.config/weston.ini
	[core]
	idle-time=0
	xwayland=true

	[shell]
	background-color=0xff000000
	panel-position=''
	locking=false
	FILE

}

session_start () {

	# take ownership and populate directories

	sudo chown --recursive "${UID}":"${UID}" "$android_media"

	sudo chmod --recursive 777 "$android_media"

	for i in ${!android_directories_list[@]}
	do
		if ! mountpoint --quiet "$android_media"/"${android_directories_list[$i]}"
		then
			sudo mkdir --parents "${android_media}"/"${android_directories_list[$i]}"

			sudo mount										\
					--bind									\
					--options uid="${UID}",gid="${UID}"		\
					--rw "${host_media}"/"${host_directories_list[$i]}" "${android_media}"/"${android_directories_list[$i]}"

		fi

	done
}

session_stop () {

	# unmount directories

	for i in ${!android_directories_list[@]}
	do
		sudo umount "${android_media}"/"${android_directories_list[$i]}" 2> "${sink}"

		echo "Unmounting ${android_media}/${android_directories_list[$i]}"
		echo
	done
}

# compositor setup

if [ ! -f "${HOME}"/.config/weston.ini ]
then
	compositor_configure
fi

if [[ "$(pgrep -f "${compositor}")" ]]
then
	pkill -f "${compositor}"
else
	width=$(xrandr --current | grep '*' | uniq | awk '{print $1}' | cut -d 'x' -f 1)
	height=$(xrandr --current | grep '*' | uniq | awk '{print $1}' | cut -d 'x' -f 2)

	weston --width="${width}" --height="${height}" --fullscreen &

	export WAYLAND_DISPLAY=wayland-1
fi

waydroid session stop

# session start

waydroid show-full-ui 2>&1 | while read -r message
do
	if echo "${message}" | grep -i 'Android with user 0 is ready'
	then
		session_start
	fi
done

# session stop

session_stop
