#!/bin/bash

set -x

# dependencies /////////////////////////////////////////////////////////////////

if [ -f "${HOME}"/.local/bin/frobulator ]
then
	rm -r -f "${HOME}"/.local/bin/frobulator
fi

if [[ -z $(command -v frobulator) ]]
then
	if [[ $(id -u -n) = "root" ]]
	then
		SUDO_HOME=/root

		USER="${SUDO_USER}"

		HOME=/home/"${USER}"
	fi

	if [[ -z $(command -v curl) ]]
	then
		yes | apt-get install curl
	fi

	if [ ! -d "${HOME}"/.local/bin ]
	then
		mkdir -p "${HOME}"/.local/bin
	fi

	curl -s -L get.frbltr.app > "${HOME}"/.local/bin/frobulator

	chmod +x "${HOME}"/.local/bin/frobulator
fi

. "${HOME}"/.local/bin/frobulator

# superuser ////////////////////////////////////////////////////////////////////

export self_arguments="${@}"

# frobulator.escalate

# variables ////////////////////////////////////////////////////////////////////

android_media="${HOME}"/.local/share/waydroid/data/media/0

host_media=/media

android_directories_list=(
	Drive
	Music
)

host_directories_list=(
	internal
	"/${USER}/Samsung T7/music"
)

# session start

waydroid session start 2>&1 | while read -r message
do
	if echo "${message}" | grep -i 'Android with user 0 is ready'
	then
		sudo chown -R "${UID}":"${UID}" "$android_media"/*

		sudo chmod -R 777 "$android_media"/*

		for i in ${!android_directories_list[@]}
		do
			if ! mountpoint -q "$android_media"/"${android_directories_list[$i]}"
			then
				sudo mkdir -p "${android_media}"/"${android_directories_list[$i]}"

				sudo mount --bind --options uid="${UID}",gid="${UID}" --rw "${host_media}"/"${host_directories_list[$i]}" "${android_media}"/"${android_directories_list[$i]}"

			fi

		done
	fi
done

# session stop

for i in ${!android_directories_list[@]}
do
	sudo umount "${android_media}"/"${android_directories_list[$i]}" 2> "${sink}"

	echo "Unmounting ${android_media}/${android_directories_list[$i]}"
	echo
done
