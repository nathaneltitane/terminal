#!/bin/bash

# login ////////////////////////////////////////////////////////////////////////

frobulator.fwd "Logging in..."
echo

# dextop ///////////////////////////////////////////////////////////////////////

if [ "${TERMUX_VERSION}" ]
then
	if [[ $(cat "${HOME}"/.dextop/dextop-environment) = xfce ]]
	then
		session_interface="XFCE"
	else
		session_interface="CONSOLE"
	fi

	if [ -f /etc/os-release ]
	then
		. /etc/os-release

		distribution_name="${NAME}"
	fi

	# settings

	if [ ! -f "${HOME}"/.dextop/dextop-settings-checkpoint ]
	then
		frobulator.fwd "Setting up..."
		echo

		dbus-launch "${HOME}"/.local/bin/container-settings

		frobulator.file "${HOME}"/.dextop dextop-settings-checkpoint

		frobulator.clear
	fi

	# update #

	if [[ $(pidof proot) ]]
	then
		:
	else
		if [[ $(cat "${HOME}"/.dextop/dextop-update) = "update" ]]
		then
			dextop -u dextop
			dextop -u shell
			dextop -u utility all

			frobulator.clear
		fi
	fi

	# audio

	if [[ $(pidof proot) ]]
	then
		echo 'default-server = 127.0.0.1'   >  /etc/pulse/client.conf
		echo 'auto-connect-localhost = yes' >> /etc/pulse/client.conf
		echo 'autospawn = no'               >> /etc/pulse/client.conf
	else
		if [[ $(cat "${HOME}"/.dextop/dextop-audio) = "audio" ]]
	    then
			if [[ $(command -v pulseaudio) ]]
			then
				if [[ $(pidof pulseaudio) ]]
				then
					:
				else
					# start pulseaudio and daemonize

					pulseaudio					\
						--start					\
						--daemonize=true		\
						--exit-idle-time=-1

					# initialize tcp connection protocol

					pacmd								\
						load-module						\
							module-native-protocol-tcp	\
								auth-ip-acl=127.0.0.1	\
								auth-anonymous=1
				fi
			fi
		fi
	fi

	# automatic session start

	if [[ $(pidof x11vnc) ]]
	then
		:
	else
		if [[ $(cat "${HOME}"/.dextop/dextop-login) = "login" ]]
	    then
			if [[ $(pidof proot) ]]
			then
				if [ -f "${HOME}"/.vnc/selection ]
				then
					echo $(cat "${HOME}"/.vnc/selection) | container-session -o
				else
					container-session -o
				fi
			fi
		fi
	fi
fi
