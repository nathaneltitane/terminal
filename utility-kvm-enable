#!/bin/bash

sudo apt install qemu-system-x86 libvirt-daemon-system virtinst \
	virt-manager virt-viewer ovmf swtpm qemu-utils guestfs-tools \
	libosinfo-bin tuned tuned-utils

sudo systemctl enable libvirtd.service

sudo nmcli connection add type bridge con-name bridge0 ifname bridge0

sudo nmcli connection add type ethernet slave-type bridge \
	con-name 'Bridge connection 1' ifname enp2s0 master bridge0

sudo nmcli connection up bridge0

sudo nmcli connection modify bridge0 connection.autoconnect-slaves 1

sudo nmcli connection up bridge0

sudo nmcli device status

sudo virsh net-define << NETWORK
<network>
<name>nwbridge</name>
<forward mode='bridge'/>
<bridge name='bridge0'/>
</network>
NETWORK

sudo virsh net-start nwbridge
sudo virsh net-autostart nwbridge

rm nwbridge.xml

sudo usermod -aG libvirt $USER

echo "export LIBVIRT_DEFAULT_URI='qemu:///system'" >> ~/.bashrc

sudo setfacl -R -b /var/lib/libvirt/images
sudo setfacl -R -m u:$USER:rwX /var/lib/libvirt/images
sudo setfacl -m d:u:$USER:rwx /var/lib/libvirt/images
